# -*- coding: utf-8 -*-
"""
í†µì´ë¯¸ì§€ 4ê°œ ëœë¤ í¬ë¡­ & ìë™ í´ë”ë§ (Simple UI, Tkinter)
- UI í†¤: ì—°í•œ íšŒìƒ‰ ë°°ê²½ + í° ì¹´ë“œ + íŒŒë‘ í¬ì¸íŠ¸ (ê¸°ì¡´ ìœ ì§€)
- GUI ë°°ì¹˜/í¬ê¸°: ê¸°ì¡´ ê·¸ëŒ€ë¡œ (1080x780)
- ê°œì„  ë¡œì§: ë¬´ê²°ì„± ê²€ì‚¬(verify + load) + ìë™ ì¬ì‹œë„ + ì›ìì  ì €ì¥(os.replace)
- ì„ì‹œíŒŒì¼ í™•ì¥ì ì´ìŠˆ í•´ê²°: img.save(..., format="PNG")
- ì¬ì‹œë„ ëŒ€ìƒ/íšŒì°¨/ê²°ê³¼ë¥¼ ëª¨ë‘ ì‹¤ì‹œê°„ ë¡œê·¸ ë° logs/ì— ê¸°ë¡
"""

import os, io, sys, random, datetime, traceback, time
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext

import numpy as np
from PIL import Image, ImageOps, UnidentifiedImageError
from openpyxl import load_workbook

# ---- UI Palette ----
UI_BG = "#F5F7FA"
UI_FG = "#1F2937"
UI_CARD = "#FFFFFF"
UI_BORDER = "#E5E7EB"
UI_ACCENT = "#2563EB"
UI_FONT = ("ë§‘ì€ ê³ ë”•", 10)
UI_FONT_TITLE = ("ë§‘ì€ ê³ ë”•", 12, "bold")

# í•‘í¬ ë°°ì§€(ì—°í•œ í•‘í¬ + ì§„í•œ ë¡œì¦ˆ í…ìŠ¤íŠ¸)
UI_PINK_BG = "#FFE4F2"
UI_PINK_FG = "#9D174D"

HELP_TEXT = (
    "[ì‚¬ìš© ë°©ë²•]\n"
    "1) ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•©ë‹ˆë‹¤.\n"
    "2) ì›ê³  ìŠ¬ë¡¯ 4ê°œì— ì´ë¯¸ì§€ì™€ ì›ê³ ë²ˆí˜¸(1~4)ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.\n"
    "3) [ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹¤í–‰]ì„ ëˆ„ë¦…ë‹ˆë‹¤.\n"
    "   - íŒŒì¼ëª…: ì›ê³ ë²ˆí˜¸_ì˜¤ëŠ˜ë‚ ì§œ_ì—°ì†ë²ˆí˜¸.png  (ì˜ˆ: 1_251020_1.png)\n"
    "   - ì—¬ë°±ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µë©ë‹ˆë‹¤.\n"
    "4) [URL ìƒì„±]ì„ ëˆ„ë¥´ë©´ ê° ê²½ë¡œì— URL.txtê°€ ìƒì„±ë©ë‹ˆë‹¤."
)

# ===== VBA ë™ë“± ìœ í‹¸ =====
def clean_seg(s: str) -> str:
    s = (s or "").strip()
    for ch in ['\\','/',':','*','?','"','<','>','|']:
        s = s.replace(ch, ' ')
    while len(s) > 0 and (s.endswith(' ') or s.endswith('.')):
        s = s[:-1]
    return s.strip()

def remove_spaces_tabs(s: str) -> str:
    return (s or "").replace(' ', '').replace('\t', '')

def parse_blog_cell(cell_text: str):
    s = (cell_text or '').strip()
    p_open = s.find('(')
    p_close = s.rfind(')')
    if p_open > -1 and p_close > p_open:
        blog_name = s[:p_open].strip()
        blog_id = s[p_open+1:p_close].strip()
    else:
        blog_name = s
        blog_id = ''
    return blog_name, blog_id

def blog_id_by_name(name: str) -> str:
    mapping = {
        "ì˜¤ëŠ˜ê°“ìƒ": "bride11231",
        "ê³„ë‹¨íƒ€ê¸°": "scold10151",
        "ì¼ë‹¨ì‹œì‘": "affair5459",
        "ì˜ˆì¨ì£¼ì˜": "cap2417",
        "ë…¸ë ¥ì²œì¬": "reserve1047",
        "ê¸€ë¡œìš°í•": "scarce8501",
        "ìŠ¬ë¦¼ì¡°ì´": "withpiano001",
        "ì‚´ê³°ë‹¬ê³°": "kbshb72",
    }
    return mapping.get((name or '').strip(), '')

def ensure_folder(path: str):
    os.makedirs(path, exist_ok=True)

def write_text_utf8(full_path: str, content: str):
    ensure_folder(os.path.dirname(full_path))
    with io.open(full_path, 'w', encoding='utf-8') as f:
        f.write(content or '')

def to_date_folder_and_medium(v_date):
    import datetime as _dt
    try:
        if isinstance(v_date, _dt.datetime):
            d = v_date
        elif isinstance(v_date, _dt.date):
            d = _dt.datetime(v_date.year, v_date.month, v_date.day)
        else:
            s = str(v_date).strip()  # '10ì›” 16ì¼'
            d = _dt.datetime.strptime(s, "%mì›” %dì¼")
            d = d.replace(year=_dt.datetime.now().year)
        date_folder = d.strftime("%y.%m.%d")
        medium = d.strftime("%y%m%d")
        return date_folder, medium
    except Exception:
        s = clean_seg(str(v_date).strip())
        medium = s.replace('.', '').replace('-', '')
        return s, medium

def today_yymmdd() -> str:
    return datetime.datetime.now().strftime("%y%m%d")

# ===== ë¬´ê²°ì„± ê²€ì‚¬ + ì¬ì‹œë„ =====
def verify_image_integrity(path: str) -> bool:
    """
    ì €ì¥ëœ PNGê°€ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ ê²€ì‚¬:
    1) êµ¬ì¡°/CRC í™•ì¸(Image.verify)
    2) ì „ì²´ ë””ì½”ë”©(Image.load)
    """
    try:
        from PIL import Image as _Image
        with _Image.open(path) as im:
            im.verify()
        with _Image.open(path) as im:
            im.load()
        return True
    except (OSError, UnidentifiedImageError):
        return False

def save_with_retry_and_integrity(img, target, logger, max_retries=10, delay=0.2):
    """
    PNGë¥¼ tmpì— ì €ì¥(í¬ë§· ëª…ì‹œ) â†’ os.replaceë¡œ ì›ìì  êµì²´ â†’ ë¬´ê²°ì„± ê²€ì‚¬
    ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„. ëª¨ë“  ì‹œë„/ê²°ê³¼ëŠ” loggerë¡œ ë‚¨ê¹€.
    """
    tmp = target + ".tmp"
    attempt = 1
    while attempt <= max_retries:
        try:
            # â˜… í•µì‹¬: í™•ì¥ì .tmpë¼ë„ Pillowê°€ í¬ë§·ì„ ì•Œ ìˆ˜ ìˆê²Œ format="PNG" ëª…ì‹œ
            img.save(tmp, format="PNG", optimize=False)
            os.replace(tmp, target)

            # ì €ì¥ í›„ ë¬´ê²°ì„± ê²€ì‚¬(verify + load)
            if verify_image_integrity(target):
                if attempt > 1:
                    logger(f"ğŸ©µ [ì •ìƒë³µêµ¬] ì¬ì‹œë„ {attempt-1}íšŒ í›„ ë¬´ê²°ì„± í†µê³¼ â†’ {target}")
                return True
            else:
                logger(f"âš ï¸ [ë¬´ê²°ì„± ì‹¤íŒ¨] {attempt}íšŒì°¨ â†’ {target}")
                attempt += 1
                time.sleep(delay)

        except Exception as e:
            logger(f"âŒ [ì €ì¥ ì‹¤íŒ¨] {attempt}íšŒì°¨ â†’ {target} | {e}")
            attempt += 1
            time.sleep(delay)
        finally:
            # ì‹¤íŒ¨ ì¼€ì´ìŠ¤ì—ì„œ tmp ì”ì¡´ ë°©ì§€
            try:
                if os.path.exists(tmp):
                    os.remove(tmp)
            except Exception:
                pass

    logger(f"âŒ [ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼] ì†ìƒëœ íŒŒì¼ ìœ ì§€ë¨ â†’ {target}")
    return False

# ===== ì—‘ì…€ ì½ê¸° (ì „ì²´í–‰) =====
def read_rows_from_excel(xlsx_path: str, logger):
    wb = load_workbook(xlsx_path, data_only=True)
    ws = wb.active
    rows = []
    for r in ws.iter_rows(min_row=1, values_only=True):
        if r is None or len(r) < 15:
            continue
        A = r[0]   # ë‚ ì§œ
        B = r[1]   # í‚¤ì›Œë“œ
        H = r[7]   # ë¸”ë¡œê·¸ëª…(ID)
        O = r[14] if len(r) > 14 else ''
        if (A is None) and (B is None) and (H is None):
            continue

        blog_name_raw, blog_id = parse_blog_cell(H)
        if not blog_id:
            blog_id = blog_id_by_name(blog_name_raw)

        blog_name = "2. " + clean_seg(blog_name_raw)
        date_folder, medium = to_date_folder_and_medium(A)
        keyword_raw = (B or '')
        keyword_folder = clean_seg(keyword_raw)
        detail_param = remove_spaces_tabs(keyword_raw)

        vname = (O or '').strip()
        nt_keyword = vname if len(vname) == 2 else "ì†Œí¬"

        base_path = r"Z:\ë¯¸ë“œë¸Œë¡œ\â¤ ë§ˆì¼€íŒ…\6.ì›ê³  ì´ë¯¸ì§€ êµì²´ ê±´"
        final_path = os.path.join(base_path, blog_name, date_folder, keyword_folder)

        url = (
            "http://innerium.co.kr/surl/p/18/?"
            f"utm_source={blog_id}/{detail_param}/{nt_keyword}/{medium}"
        )

        rows.append({
            "final_path": final_path,
            "url": url,
            "blog_name": blog_name,
            "date_folder": date_folder,
            "keyword_folder": keyword_folder,
            "medium": medium,
            "nt_keyword": nt_keyword
        })
    logger(f"â„¹ï¸ [ì—‘ì…€] ì´ {len(rows)}í–‰ ë¡œë“œ ì™„ë£Œ")
    return rows

# ===== ì´ë¯¸ì§€ ìœ í‹¸ =====
def load_image_exif_oriented(path: str) -> Image.Image:
    """
    ì›ë³¸ì„ ì™„ì „íˆ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œí•˜ê³  íŒŒì¼ í•¸ë“¤ì„ ë‹«ê¸° ìœ„í•´ copy ì‚¬ìš©.
    (ì§€ì—° ë¡œë“œ/íŒŒì¼ ë½ ì˜í–¥ ìµœì†Œí™”)
    """
    with Image.open(path) as im:
        im = ImageOps.exif_transpose(im)
        im = im.convert("RGB")
        return im.copy()

def is_row_white(arr_row, thresh=250):
    return np.all(arr_row >= thresh)

def detect_top_bottom_white_margins(img: Image.Image, thresh=250):
    img_rgb = img.convert("RGB")
    arr = np.array(img_rgb)
    H, W, _ = arr.shape

    top_margin = 0
    for y in range(H):
        if is_row_white(arr[y, :, :], thresh):
            top_margin += 1
        else:
            break

    bottom_margin = 0
    for y in range(H-1, -1, -1):
        if is_row_white(arr[y, :, :], thresh):
            bottom_margin += 1
        else:
            break

    return top_margin, bottom_margin

def pick_random_cuts(top_margin, bottom_margin):
    if top_margin < 1 or bottom_margin < 1:
        return None, None
    top_cut = random.randint(1, top_margin)
    bottom_cut = random.randint(1, bottom_margin)
    return top_cut, bottom_cut

def next_available_filename(dirpath: str, base_name_no_ext: str, ext: str) -> str:
    seq = 1
    while True:
        candidate = f"{base_name_no_ext}_{seq}{ext}"
        full = os.path.join(dirpath, candidate)
        if not os.path.exists(full):
            return full
        seq += 1

# ===== ì²˜ë¦¬ ë¡œì§ =====
def process_images_for_all_rows(excel_rows, slots, logger, progress_cb):
    valid = [(p, n) for (p, n) in slots if p and n in [1,2,3,4]]
    total_jobs = len(valid) * len(excel_rows)
    done = 0
    if total_jobs == 0:
        logger("â„¹ï¸ [ì‹¤í–‰] ì²˜ë¦¬í•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤(ì´ë¯¸ì§€/ì›ê³ ë²ˆí˜¸ í™•ì¸).")
        progress_cb(0)
        return

    today = today_yymmdd()

    for (img_path, wn) in valid:
        try:
            base_img = load_image_exif_oriented(img_path)
            W, H = base_img.size
            top_margin, bottom_margin = detect_top_bottom_white_margins(base_img, thresh=250)
            if top_margin < 1 or bottom_margin < 1:
                logger(f"â­ï¸ [ìŠ¤í‚µ] ì—¬ë°± ì—†ìŒ/ë¶€ì¡± â†’ {os.path.basename(img_path)} "
                       f"(top={top_margin}, bottom={bottom_margin})")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            top_cut, bottom_cut = pick_random_cuts(top_margin, bottom_margin)
            if top_cut is None:
                logger(f"â­ï¸ [ìŠ¤í‚µ] ëœë¤ ì»· ë¶ˆê°€(ì—¬ë°±<1px) â†’ {os.path.basename(img_path)}")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            L, T, R, B = 0, top_cut, W, H - bottom_cut
            if T >= B:
                logger(f"â­ï¸ [ìŠ¤í‚µ] í¬ë¡­ ë²”ìœ„ ë¹„ì •ìƒ(T>=B) â†’ {os.path.basename(img_path)}")
                done += len(excel_rows)
                progress_cb(int(done*100/total_jobs))
                continue

            # PNG ì €ì¥ ì „ ìƒ‰ëª¨ë“œ ì •ê·œí™”ëœ í¬ë¡­
            cropped = base_img.crop((L, T, R, B))

        except Exception as e:
            logger(f"âŒ [ì—ëŸ¬] ì´ë¯¸ì§€ ë¡œë“œ/ì—¬ë°±ê²€ì¶œ ì‹¤íŒ¨: {os.path.basename(img_path)} | {e}")
            done += len(excel_rows)
            progress_cb(int(done*100/total_jobs))
            continue

        for row in excel_rows:
            try:
                final_dir = row["final_path"]
                ensure_folder(final_dir)
                base_no_ext = f"{wn}_{today}"
                target = next_available_filename(final_dir, base_no_ext, ".png")

                # === ê°œì„ ëœ ì €ì¥: ë¬´ê²°ì„± ê²€ì‚¬ + ì¬ì‹œë„ + ìƒì„¸ ë¡œê·¸ ===
                ok = save_with_retry_and_integrity(cropped, target, logger, max_retries=10, delay=0.2)
                if ok:
                    logger(f"âœ… [ì„±ê³µ] ë¬´ê²°ì„± í†µê³¼: {target}")
                else:
                    logger(f"âŒ [ì‹¤íŒ¨] ëê¹Œì§€ ë¬´ê²°ì„± í™•ë³´ ì‹¤íŒ¨: {target}")

            except Exception as e:
                logger(f"âŒ [ì—ëŸ¬] ì €ì¥ ì¤‘ ì˜ˆì™¸: {row['final_path']} | {os.path.basename(img_path)} | {e}")
            finally:
                done += 1
                progress_cb(int(done*100/total_jobs))

def generate_urls_for_all_rows(excel_rows, logger):
    """
    ê° í–‰ í´ë”ì— URL.txt ìƒì„±

    ë‚´ìš© í˜•ì‹:
    1ìœ„ ë°°í•©ëŸ‰ ë™ì¼ 

    (ê¸°ì¡´ ì €ì¥í•˜ë˜ ë§í¬)

    https://smartstore.naver.com/globalreporter/products/9732262671?ref={weekday}{medium}?v=000001

    https://www.skstoa.com/display/goods/42990779?ref={weekday}{medium}?v=000001

    â€» ê°™ì€ í‚¤ì›Œë“œ(ê°™ì€ í–‰)ì—ì„œëŠ” 2ìœ„/3ìœ„ì˜ v ê°’ì´ ë™ì¼,
       ë‹¤ìŒ í‚¤ì›Œë“œë¡œ ë„˜ì–´ê°ˆ ë•Œ vê°€ 1ì”© ì¦ê°€(000001, 000002, â€¦)
    """
    cnt = 0

    # ì˜¤ëŠ˜ ìš”ì¼(ì˜ì–´) - ì˜ˆ: Monday, Tuesday...
    today_weekday = datetime.datetime.now().strftime("%A")  # ì˜ì–´ ìš”ì¼

    # 2Â·3ìœ„ ê³ ì • ë² ì´ìŠ¤ URL
    base2 = "https://smartstore.naver.com/globalreporter/products/9732262671"
    base3 = "https://www.skstoa.com/display/goods/42990779"

    v_counter = 1  # í‚¤ì›Œë“œ(í–‰)ë³„ v ê°’ ì¹´ìš´í„°

    for row in excel_rows:
        try:
            dest_dir = row["final_path"]
            ensure_folder(dest_dir)

            # ê¸°ì¡´ 1ìœ„ ë§í¬
            link1 = row["url"]

            # medium(ì˜ˆ: 251010)
            medium = str(row.get("medium", "")).strip()

            # í˜„ì¬ í‚¤ì›Œë“œìš© v ê°’ (6ìë¦¬)
            v_str = f"{v_counter:06d}"  # 000001, 000002, ...

            # 2ìœ„ / 3ìœ„ ë§í¬ ìƒì„±
            # ì˜ˆ: ?ref=monday251010?v=000001
            link2 = f"{base2}?ref={today_weekday.lower()}{medium}?v={v_str}"
            link3 = f"{base3}?ref={today_weekday.lower()}{medium}?v={v_str}"

            # ë©”ëª¨ì¥ ë‚´ìš©
            lines = [
                "1ìœ„ ë°°í•©ëŸ‰ ë™ì¼",
                "",
                link1,
                "",
                link2,
                "",
                link3,
                ""
            ]
            content = "\n".join(lines)

            full_path = os.path.join(dest_dir, "URL.txt")
            write_text_utf8(full_path, content)
            cnt += 1

            # ë‹¤ìŒ í‚¤ì›Œë“œë¡œ ë„˜ì–´ê°ˆ ë•Œ v + 1
            v_counter += 1

        except Exception as e:
            logger(f"âŒ [ì—ëŸ¬] URL.txt ì €ì¥ ì‹¤íŒ¨: {row.get('final_path','?')} | {e}")

    logger(f"âœ… [URL] ìƒì„± ì™„ë£Œ: {cnt}ê°œ")



# ===== GUI =====
class App:
    def __init__(self, root):
        self.root = root
        root.title("í†µì´ë¯¸ì§€ 4ê°œ í¬ë¡­ & ìë™ í´ë”ë§")
        root.geometry("1080x780")            # ê¸°ì¡´ í¬ê¸° ê·¸ëŒ€ë¡œ
        root.configure(bg=UI_BG)

        # ttk ìŠ¤íƒ€ì¼
        style = ttk.Style()
        try:
            style.theme_use('clam')
        except Exception:
            pass
        style.configure("TLabel", background=UI_BG, foreground=UI_FG, font=UI_FONT)
        style.configure("TFrame", background=UI_BG)
        style.configure("TLabelframe", background=UI_BG, foreground=UI_FG)
        style.configure("TLabelframe.Label", background=UI_BG, foreground=UI_FG, font=UI_FONT)
        style.configure("TButton", font=UI_FONT, padding=6)
        style.configure("Card.TLabelframe", background=UI_CARD, relief="solid",
                        bordercolor=UI_BORDER, borderwidth=1)
        style.configure("Card.TLabelframe.Label", background=UI_CARD, foreground=UI_FG, font=UI_FONT)
        style.configure("Accent.Horizontal.TProgressbar", troughcolor="#EEF2FF", background=UI_ACCENT)

        # ìƒë‹¨ ì˜ì—­ (ì œëª© + ì„¤ëª…: í•­ìƒ ì™¼ìª½ ì •ë ¬)
        frm_top = ttk.Frame(root, style="TFrame")
        frm_top.pack(fill="x", padx=16, pady=12)
        tk.Label(frm_top, text="ì´ë¯¸ì§€ ìë™ í¬ë¡­ & í´ë”ë§", font=UI_FONT_TITLE, bg=UI_BG, fg=UI_FG)\
            .pack(anchor="w")
        tk.Label(frm_top, text=HELP_TEXT, font=UI_FONT, bg=UI_BG, fg=UI_FG,
                 justify="left", anchor="w")\
            .pack(fill="x", pady=(4,0), anchor="w")

        # ì—‘ì…€ ì„ íƒ (í•‘í¬ ë°°ì§€ labelwidget ì ìš©)
        frm_x_container = ttk.Frame(root, style="TFrame")
        frm_x_container.pack(fill="x", padx=16, pady=(6,12))

        xl_title = tk.Label(frm_x_container, text="ì—‘ì…€ íŒŒì¼(ì „ì²´í–‰ ì‚¬ìš©)",
                            bg=UI_PINK_BG, fg=UI_PINK_FG,
                            font=("ë§‘ì€ ê³ ë”•", 10, "bold"), padx=8, pady=2)
        frm_x = ttk.LabelFrame(frm_x_container, labelwidget=xl_title,
                               style="Card.TLabelframe", padding=0)
        frm_x.pack(fill="x")

        inner_x = ttk.Frame(frm_x, padding=8, style="TFrame")
        inner_x.pack(fill="x")
        self.xlsx_var = tk.StringVar()
        ent = ttk.Entry(inner_x, textvariable=self.xlsx_var)
        ent.pack(side="left", fill="x", expand=True, padx=(0,6))
        ttk.Button(inner_x, text="ì°¾ê¸°", command=self.pick_excel).pack(side="left")
        self.load_stat = tk.StringVar(value="ì—‘ì…€ ë¯¸ì„ íƒ")
        ttk.Label(inner_x, textvariable=self.load_stat).pack(side="left", padx=10)

        # ì›ê³  ìŠ¬ë¡¯ 4ê°œ (2x2) â€” í•‘í¬ ë°°ì§€ labelwidget ì‚¬ìš©
        frm_slots = ttk.Frame(root, style="TFrame")
        frm_slots.pack(fill="both", expand=True, padx=16, pady=6)
        for r in range(2): frm_slots.rowconfigure(r, weight=1)
        for c in range(2): frm_slots.columnconfigure(c, weight=1)

        self.slot_img_vars = []
        self.slot_no_vars = []
        slot_frames = []
        for i in range(1, 5):
            title = tk.Label(frm_slots, text=f"ì›ê³  ìŠ¬ë¡¯ {i}",
                             bg=UI_PINK_BG, fg=UI_PINK_FG,
                             font=("ë§‘ì€ ê³ ë”•", 10, "bold"), padx=8, pady=2)
            f = ttk.LabelFrame(frm_slots, labelwidget=title, style="Card.TLabelframe", padding=0)
            slot_frames.append(f)

        slot_frames[0].grid(row=0, column=0, sticky="nsew", padx=6, pady=6)
        slot_frames[1].grid(row=0, column=1, sticky="nsew", padx=6, pady=6)
        slot_frames[2].grid(row=1, column=0, sticky="nsew", padx=6, pady=6)
        slot_frames[3].grid(row=1, column=1, sticky="nsew", padx=6, pady=6)

        for i in range(1, 5):
            frame = slot_frames[i-1]
            inner = ttk.Frame(frame, padding=8, style="TFrame")
            inner.pack(fill="both", expand=True)

            row1 = ttk.Frame(inner, style="TFrame"); row1.pack(fill="x", pady=(2,4))
            ttk.Label(row1, text="ì´ë¯¸ì§€ íŒŒì¼:").pack(side="left")
            ivar = tk.StringVar(); self.slot_img_vars.append(ivar)
            e = ttk.Entry(row1, textvariable=ivar); e.pack(side="left", fill="x", expand=True, padx=6)
            ttk.Button(row1, text="ì„ íƒ", command=lambda v=ivar: self.pick_image(v)).pack(side="left")

            row2 = ttk.Frame(inner, style="TFrame"); row2.pack(fill="x")
            ttk.Label(row2, text="ì›ê³ ë²ˆí˜¸(1~4):").pack(side="left")
            nvar = tk.StringVar(value=str(i)); self.slot_no_vars.append(nvar)
            ttk.Spinbox(row2, from_=1, to=4, textvariable=nvar, width=5)\
                .pack(side="left", padx=(6, 0))

        # ì•¡ì…˜ ë²„íŠ¼ (ê°€ìš´ë° ì •ë ¬)
        frm_act_outer = ttk.Frame(root, style="TFrame")
        frm_act_outer.pack(fill="x", padx=16, pady=8)
        frm_act_inner = ttk.Frame(frm_act_outer, style="TFrame")
        frm_act_inner.pack()
        btn_run = ttk.Button(frm_act_inner, text="ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹¤í–‰", command=self.run_crop)
        btn_url = ttk.Button(frm_act_inner, text="URL ìƒì„±", command=self.run_url)
        btn_run.pack(side="left", padx=8, pady=2)
        btn_url.pack(side="left", padx=8, pady=2)

        # ì§„í–‰ë¥ ë°”: ë¼ë²¨ + % í‘œì‹œ
        frm_prog = ttk.Frame(root, style="TFrame")
        frm_prog.pack(fill="x", padx=16, pady=(0,6))
        ttk.Label(frm_prog, text="ì§„í–‰ë¥ ").pack(anchor="w")
        self.prog = ttk.Progressbar(frm_prog, style="Accent.Horizontal.TProgressbar",
                                    maximum=100, mode="determinate")
        self.prog.pack(fill="x")
        self.prog_pct = tk.StringVar(value="0%")
        tk.Label(frm_prog, textvariable=self.prog_pct, font=("ë§‘ì€ ê³ ë”•", 9),
                 bg=UI_BG, fg="#374151").pack(anchor="e", pady=(2,0))

        # ë¡œê·¸
        self.log = scrolledtext.ScrolledText(root, height=16)
        self.log.configure(bg="#FFFFFF", fg="#111827", font=("Consolas", 10))
        self.log.pack(fill="both", expand=True, padx=16, pady=6)

        # ìƒíƒœ
        self.excel_rows = []
        self.logs_dir = os.path.join(os.getcwd(), "logs")
        os.makedirs(self.logs_dir, exist_ok=True)
        self.log_file = os.path.join(self.logs_dir, datetime.datetime.now().strftime("%Y%m%d_%H%M%S") + ".txt")

    def pick_excel(self):
        path = filedialog.askopenfilename(
            title="ì—‘ì…€ íŒŒì¼ ì„ íƒ",
            filetypes=[("Excel", "*.xlsx *.xlsm *.xltx *.xltm")]
        )
        if not path:
            return
        self.xlsx_var.set(path)
        self.log_clear()
        self.prog_set(0)
        try:
            self.excel_rows = read_rows_from_excel(path, self.logger)
            self.load_stat.set(f"ë¡œë“œë¨: {len(self.excel_rows)}í–‰")
        except Exception as e:
            self.excel_rows = []
            self.load_stat.set("ë¡œë“œ ì‹¤íŒ¨")
            self.logger(f"âŒ [ì—ëŸ¬] ì—‘ì…€ ë¡œë“œ ì‹¤íŒ¨: {e}")

    def pick_image(self, var: tk.StringVar):
        path = filedialog.askopenfilename(
            title="ì´ë¯¸ì§€ ì„ íƒ",
            filetypes=[("ì´ë¯¸ì§€", "*.jpg *.jpeg *.png *.bmp *.tif *.tiff *.webp")]
        )
        if path:
            var.set(path)

    def run_crop(self):
        if not self.excel_rows:
            self.logger("â„¹ï¸ [ì‹¤í–‰ì¤‘ë‹¨] ì—‘ì…€ì„ ë¨¼ì € ì„ íƒ/ë¡œë“œí•˜ì„¸ìš”.")
            return
        slots = []
        for i in range(4):
            imgp = self.slot_img_vars[i].get().strip() or None
            try:
                wno = int((self.slot_no_vars[i].get() or "").strip())
            except:
                wno = None
            if wno not in [1,2,3,4]:
                if imgp:
                    self.logger(f"â„¹ï¸ [ì•Œë¦¼] ìŠ¬ë¡¯{i+1}: ì›ê³ ë²ˆí˜¸ 1~4 ì•„ë‹˜ â†’ ì œì™¸")
                slots.append((None, None))
            else:
                slots.append((imgp, wno))

        try:
            self.prog_set(0)
            self.logger("â–¶ï¸ [ì‹¤í–‰] ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ì‹œì‘")
            process_images_for_all_rows(self.excel_rows, slots, self.logger, self.prog_set)
            self.logger("âœ… [ì™„ë£Œ] ì´ë¯¸ì§€ í¬ë¡­Â·ì €ì¥ ë")
        except Exception as e:
            self.logger(f"âŒ [ì—ëŸ¬] ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: {e}\n{traceback.format_exc()}")
        finally:
            self.flush_log_to_file()

    def run_url(self):
        if not self.excel_rows:
            self.logger("â„¹ï¸ [ì‹¤í–‰ì¤‘ë‹¨] ì—‘ì…€ì„ ë¨¼ì € ì„ íƒ/ë¡œë“œí•˜ì„¸ìš”.")
            return
        try:
            self.logger("â–¶ï¸ [URL] ìƒì„± ì‹œì‘")
            generate_urls_for_all_rows(self.excel_rows, self.logger)
            self.logger("âœ… [URL] ìƒì„± ë")
        except Exception as e:
            self.logger(f"âŒ [ì—ëŸ¬] URL ìƒì„± ì¤‘ ì˜ˆì™¸: {e}")
        finally:
            self.flush_log_to_file()

    # ---- ë¡œê·¸/ì§„í–‰ ----
    def logger(self, msg: str):
        ts = datetime.datetime.now().strftime("%H:%M:%S")
        self.log.config(state="normal")
        self.log.insert("end", f"[{ts}] {msg}\n")
        self.log.see("end")
        self.log.config(state="disabled")
        self.root.update_idletasks()

    def log_clear(self):
        self.log.config(state="normal")
        self.log.delete("1.0", "end")
        self.log.config(state="disabled")

    def prog_set(self, percent: int):
        percent = max(0, min(100, int(percent)))
        self.prog['value'] = percent
        self.prog_pct.set(f"{percent}%")
        self.root.update_idletasks()

    def flush_log_to_file(self):
        try:
            content = self.log.get("1.0", "end")
            with io.open(self.log_file, "w", encoding="utf-8") as f:
                f.write(content)
        except Exception:
            pass

def main():
    root = tk.Tk()
    App(root)
    root.mainloop()

if __name__ == "__main__":
    main()
